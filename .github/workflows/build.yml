# 工作流名称
name: Build Dylib with Substrate

# 触发条件
on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      # 1. 检出代码
      - name: Checkout repository code
        uses: actions/checkout@v4

      # 2. 【新增步骤】下载并提取 libsubstrate.dylib
      - name: Download and Extract Substrate
        run: |
          echo "--- Downloading MobileSubstrate package ---"
          # 从一个可靠的官方源下载 .deb 文件
          curl -LO http://apt.saurik.com/debs/mobilesubstrate_0.9.7111_iphoneos-arm.deb
          
          echo "--- Extracting .deb package ---"
          # 使用 ar 工具提取 .deb 包中的 data.tar.xz
          ar -x mobilesubstrate_0.9.7111_iphoneos-arm.deb
          
          echo "--- Extracting dylib from data archive ---"
          # 使用 tar 工具从 data.tar.xz 中提取我们需要的 dylib 到当前目录
          tar -xf data.tar.xz ./usr/lib/libsubstrate.dylib
          
          echo "--- Moving dylib to current directory ---"
          # 将 dylib 移动到根目录，方便 Makefile 查找
          mv ./usr/lib/libsubstrate.dylib .

      # 3. 执行编译
      - name: Compile the dylib
        run: make

      # 4. 检查生成的文件
      - name: List files after build
        run: ls -la

      # 5. 上传编译产物以供下载
      - name: Upload dylib artifact
        uses: actions/upload-artifact@v4
        with:
          name: ColorHook-Dylib
          path: ColorHook.dylib
