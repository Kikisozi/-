# 工作流名称
name: Build Dylib with Theos Dependencies

# 触发条件
on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      # 1. 检出代码
      - name: Checkout repository code
        uses: actions/checkout@v4

      # 2. 【最终修正】下载并提取依赖库
      - name: Download and Extract Dependencies
        run: |
          echo "--- Downloading libsubstrate from Theos repo ---"
          # 使用Theos项目维护的更可靠的源
          curl -LO https://github.com/theos/sdks/raw/master/lib/libsubstrate.dylib
          
          echo "--- Verifying downloaded file ---"
          # 验证下载的是否是一个有效的 dylib 文件，而不是HTML错误页面
          # file命令会输出文件类型，我们用grep检查是否包含 "Mach-O" (可执行文件特征)
          file libsubstrate.dylib | grep "Mach-O"
          
          if [ $? -ne 0 ]; then
            echo "Error: Downloaded file is not a valid dylib."
            exit 1
          fi
          
          echo "--- Dependencies ready ---"

      # 3. 执行编译
      - name: Compile the dylib
        run: make

      # 4. 检查生成的文件
      - name: List files after build
        run: ls -la

      # 5. 上传编译产物以供下载
      - name: Upload dylib artifact
        uses: actions/upload-artifact@v4
        with:
          name: ColorHook-Dylib
          path: ColorHook.dylib
